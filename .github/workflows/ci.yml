name: Test Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    # Run CI for PRs targeting any branch (not just `main`).
    branches: [ "**" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo fmt --all --check

  test:
    name: Run Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Run tests
      run: NEO_PI_CCS_PREFLIGHT=1 NEO_SELF_VERIFY=1 NEO_STRICT_IO_PARITY=1 cargo test --release --workspace --features "testing,debug-log,fs-guard"

  # ============================================================================
  # WASM Build Checks (with Spartan)
  # Ensures web-wasm, ios-wasm, and android-wasm builds don't break
  # ============================================================================

  wasm-builds:
    name: WASM Builds (Web/iOS/Android)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust (wasm32 + rust-src)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
        components: rust-src
    
    - name: Install Rust (nightly-2025-09-01 wasm32 + rust-src)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly-2025-09-01
        targets: wasm32-unknown-unknown
        components: rust-src

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: demos/wasm-demo/wasm

    - name: Install wasm-pack
      uses: jetli/wasm-pack-action@v0.4.0

    - name: Build WASM bundles (Web/iOS/Android)
      run: ./demos/build_wasm.sh --release
      env:
        RUSTUP_TOOLCHAIN: stable
        WASM_THREADS_TOOLCHAIN: nightly-2025-09-01
